<!DOCTYPE html>
<html>
<head>
    <title>Composition</title>
    <meta charset="utf-8" />
</head>
<body>
    <textarea id="editor" name="editor"></textarea>
    <div id="content-storage" style="display: none;">
        <p id="message"></p>
        <p id="signature"></p>
        {{HEADER}}
        {{QUOTE}}
    </div>

    <!-- ReSharper disable Html.PathError -->
    <script type="text/javascript" src="Resources/jquery/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="Resources/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="Resources/ckeditor/adapters/jquery.js"></script>
    <!-- ReSharper restore Html.PathError -->

    <script type="text/javascript">
        // Module pattern: https://github.com/stevekwan/experiments/blob/master/javascript/module-pattern.html

        var Crystalbyte = Crystalbyte || {};
        Crystalbyte.Paranoia = function () {
            var noEditorMessage = "Editor not found.";

            var textarea = $('textarea#editor');

            var loadContent = function () {
                var storage = $('#content-storage');
                storage.show();

                textarea.val(storage.html());
                storage.remove();

                resizeEditor();
                external.onContentLoaded(textarea.val());
            }

            var resizeEditor = function () {
                var w = $(window);
                var height = w.height();
                var width = w.width();
                var editor = textarea.editor;
                if (editor === null || editor === undefined) {
                    return;
                }

                editor.resize(width, height, false);
            }

            var focusEditor = function () {
                var editor = textarea.editor;
                if (!editor) {
                    alert(noEditorMessage);
                    return;
                }
                editor.focus();
            }

            var getComposition = function () {
                return textarea.val();
            }

            var setReadOnly = function (readOnly) {
                var editor = textarea.editor;
                if (!editor) {
                    alert(noEditorMessage);
                    return;
                }
                editor.setReadOnly(readOnly);
            }

            var insertText = function (text) {
                var editor = textarea.editor;
                if (!editor) {
                    alert(noEditorMessage);
                    return;
                }
                editor.insertText(text);
            }

            var insertHtml = function (html) {
                var editor = textarea.editor;
                if (editor === null || editor === undefined) {
                    alert(noEditorMessage);
                    return;
                }

                editor.insertHtml(html);
            }

            var setComposition = function (html) {
                textarea.val(html);
            }

            var execute = function (command) {
                var editor = textarea.editor;
                if (editor === null || editor === undefined) {
                    alert(noEditorMessage);
                    return;
                }

                editor.execCommand(command);
            }

            var init = function () {
                textarea.ckeditor(loadContent, {
                    startupFocus: true,
                    language: '{{CULTURE}}',
                    skin: '{{CKEDITOR_THEME}}',
                });
            }

            return {
                init: init,
                execute: execute,
                insertHtml: insertHtml,
                insertText: insertText,
                setReadOnly: setReadOnly,
                focusEditor: focusEditor,
                resizeEditor: resizeEditor,
                getComposition: getComposition,
                setComposition: setComposition,
            };
        }();

        $(window).resize(Crystalbyte.Paranoia.resizeEditor);
    </script>
</body>
</html>
