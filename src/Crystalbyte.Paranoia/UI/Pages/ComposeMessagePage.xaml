<Page x:Class="Crystalbyte.Paranoia.UI.Pages.ComposeMessagePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:paranoia="clr-namespace:Crystalbyte.Paranoia"
      xmlns:properties="clr-namespace:Crystalbyte.Paranoia.Properties"
      xmlns:system="clr-namespace:System;assembly=mscorlib"
      xmlns:ui="clr-namespace:Crystalbyte.Paranoia.UI"
      Title="{x:Static properties:Resources.ComposeMessagePageTitle}"
      FocusManager.FocusedElement="{Binding ElementName=RecipientsBox}"
      d:DataContext="{d:DesignInstance paranoia:MailCompositionContext}"
      d:DesignHeight="300"
      d:DesignWidth="300"
      mc:Ignorable="d">
    <Page.Resources>
        <DataTemplate x:Key="ContactSuggestionTemplate" DataType="paranoia:MailContactContext">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Image Grid.Column="0"
                       Width="40"
                       Margin="2,2,12,2"
                       HorizontalAlignment="Stretch"
                       RenderOptions.BitmapScalingMode="Fant"
                       Source="{Binding Address,
                                        IsAsync=True,
                                        Converter={StaticResource GravatarImageConverter}}"
                       Stretch="Uniform" />
                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock FontSize="{DynamicResource Metro.MediumLargeFontSize}"
                               FontWeight="Thin"
                               Foreground="{DynamicResource Metro.NormalTextBrush}"
                               Text="{Binding Name}" />
                    <TextBlock FontWeight="Thin"
                               Foreground="{DynamicResource Metro.SecondaryTextBrush}"
                               Text="{Binding Address}" />
                </StackPanel>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="StringTokenTemplate" DataType="system:String">
            <Grid>
                <Rectangle Fill="{DynamicResource Metro.AccentBrush}" RenderOptions.EdgeMode="Aliased" />
                <TextBlock Margin="2,0,2,0"
                           Background="Transparent"
                           FontWeight="Regular"
                           Text="{Binding}" />
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="ContactTokenTemplate" DataType="paranoia:MailContactContext">
            <Grid>
                <Rectangle Fill="{DynamicResource Metro.AccentBrush}"
                           RenderOptions.EdgeMode="Aliased"
                           SnapsToDevicePixels="True" />
                <StackPanel Orientation="Horizontal">
                    <Image Width="16"
                           VerticalAlignment="Center"
                           RenderOptions.BitmapScalingMode="LowQuality"
                           Source="{Binding Address,
                                            IsAsync=True,
                                            Converter={StaticResource GravatarImageConverter},
                                            ConverterParameter=16}" />
                    <TextBlock Margin="2,0,2,0"
                               Background="Transparent"
                               FontWeight="Regular"
                               Foreground="{DynamicResource Metro.NormalTextBrush}"
                               Text="{Binding Name}" />
                </StackPanel>

            </Grid>
        </DataTemplate>
    </Page.Resources>
    <Page.InputBindings>
        <KeyBinding Key="Enter"
                    Command="{Binding SendCommand}"
                    Modifiers="Control" />
    </Page.InputBindings>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" MaxHeight="45" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <TextBlock Grid.Row="0"
                   Grid.Column="0"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Center"
                   Text="{x:Static properties:Resources.Recipients}" />
        <Grid Grid.Row="0" Grid.Column="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <ui:AutoCompleteBox x:Name="RecipientsBox"
                                Grid.Row="0"
                                Grid.Column="0"
                                HorizontalAlignment="Stretch"
                                ItemTemplate="{StaticResource ContactSuggestionTemplate}"
                                ItemsSource="{Binding Suggestions}"
                                ItemsSourceRequested="OnRecipientsBoxItemsSourceRequested"
                                SelectedValuesChanged="OnRecipientsBoxSelectionChanged"
                                StringTokenTemplate="{StaticResource StringTokenTemplate}"
                                TokenTemplate="{StaticResource ContactTokenTemplate}" />
            <ToggleButton x:Name="CopyButton"
                          Grid.Row="0"
                          Grid.Column="1"
                          Margin="3,0,0,0"
                          VerticalAlignment="Center">
                <Image Width="18"
                       VerticalAlignment="Center"
                       Source="/Assets/message.copy.png" />
            </ToggleButton>

        </Grid>
        <TextBlock Grid.Row="1"
                   Grid.Column="0"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Center"
                   Text="{x:Static properties:Resources.CarbonCopies}"
                   Visibility="{Binding IsChecked,
                                        ElementName=CopyButton,
                                        Converter={StaticResource BooleanToVisibilityConverter}}" />
        <ui:AutoCompleteBox x:Name="CcBox"
                            Grid.Row="1"
                            Grid.Column="1"
                            HorizontalAlignment="Stretch"
                            ItemTemplate="{StaticResource ContactSuggestionTemplate}"
                            ItemsSource="{Binding Suggestions}"
                            ItemsSourceRequested="OnRecipientsBoxItemsSourceRequested"
                            SelectedValuesChanged="OnRecipientsBoxSelectionChanged"
                            StringTokenTemplate="{StaticResource StringTokenTemplate}"
                            TokenTemplate="{StaticResource ContactTokenTemplate}"
                            Visibility="{Binding IsChecked,
                                                 ElementName=CopyButton,
                                                 Converter={StaticResource BooleanToVisibilityConverter}}" />
        <TextBlock Grid.Row="2"
                   Grid.Column="0"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Center"
                   Text="{x:Static properties:Resources.BlindCarbonCopies}"
                   Visibility="{Binding IsChecked,
                                        ElementName=CopyButton,
                                        Converter={StaticResource BooleanToVisibilityConverter}}" />
        <ui:AutoCompleteBox x:Name="BccBox"
                            Grid.Row="2"
                            Grid.Column="1"
                            HorizontalAlignment="Stretch"
                            ItemTemplate="{StaticResource ContactSuggestionTemplate}"
                            ItemsSource="{Binding Suggestions}"
                            ItemsSourceRequested="OnRecipientsBoxItemsSourceRequested"
                            SelectedValuesChanged="OnRecipientsBoxSelectionChanged"
                            StringTokenTemplate="{StaticResource StringTokenTemplate}"
                            TokenTemplate="{StaticResource ContactTokenTemplate}"
                            Visibility="{Binding IsChecked,
                                                 ElementName=CopyButton,
                                                 Converter={StaticResource BooleanToVisibilityConverter}}" />

        <TextBlock Grid.Row="3"
                   Grid.Column="0"
                   Margin="0,0,12,0"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Center"
                   Text="{x:Static properties:Resources.Subject}" />
        <TextBox x:Name="SubjectTextBox"
                 Grid.Row="3"
                 Grid.Column="1"
                 Text="{Binding Subject,
                                Mode=TwoWay}" />
        <ListView Grid.Row="4"
                  Grid.Column="0"
                  Grid.ColumnSpan="2"
                  Background="Transparent"
                  ItemsSource="{Binding Attachments}"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  ScrollViewer.VerticalScrollBarVisibility="Auto">
            <ListView.Style>
                <Style BasedOn="{StaticResource {x:Type ListView}}" TargetType="ListView">
                    <Style.Triggers>
                        <Trigger Property="HasItems" Value="False">
                            <Setter Property="Visibility" Value="Hidden" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </ListView.Style>
            <ListView.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ListView.ItemsPanel>
            <ListView.ItemTemplate>
                <ItemContainerTemplate>
                    <Grid Width="120" Height="20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100" />
                            <ColumnDefinition Width="20" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Margin="2,0,2,0"
                                   VerticalAlignment="Center"
                                   Foreground="#BADA55"
                                   Text="{Binding Name}"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTip="{Binding FullName}" />
                        <!--  TODO usefull tooltip  -->
                        <Button Grid.Column="1"
                                Command="{Binding RemoveAttachmentCommand}"
                                Content="X"
                                ToolTip="remove" />
                    </Grid>
                </ItemContainerTemplate>
            </ListView.ItemTemplate>
        </ListView>
        <Border Grid.Row="5"
                Grid.Column="0"
                Grid.ColumnSpan="2"
                Margin="0,3,0,0"
                Background="{DynamicResource Metro.ControlBackgroundBrush}"
                BorderThickness="0"
                Padding="0">
            <ui:HtmlControl x:Name="HtmlControl"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            AllowDrop="True"
                            Background="{DynamicResource Metro.ControlBackgroundBrush}"
                            Drop="DropHtmlControl"
                            IsTransparent="True"
                            Padding="3"
                            RenderTransformOrigin="0.5,0.5"
                            Source="{Binding Source,
                                             Mode=TwoWay}"
                            Visibility="Collapsed" />
        </Border>


        <ui:MetroCircleButton Grid.Row="6"
                              Grid.Column="0"
                              HorizontalAlignment="Left"
                              Command="{Binding SendCommand}"
                              Text="{x:Static properties:Resources.Send}">
            <Image Width="18"
                   Margin="0,0,0,0"
                   Source="/Assets/message.png" />
        </ui:MetroCircleButton>
        <ui:MetroCircleButton Grid.Row="6"
                              Grid.Column="1"
                              HorizontalAlignment="Right"
                              Command="{Binding AddattachmentCommand}"
                              Text="{x:Static properties:Resources.AddAttachment}">
            <Image Width="18"
                   Margin="0,0,0,0"
                   Source="/Assets/message.png" />
        </ui:MetroCircleButton>
    </Grid>
</Page>